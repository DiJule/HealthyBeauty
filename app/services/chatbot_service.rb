class ChatbotService
  def initialize(message)
    @message = message.to_s.downcase.strip
  end

  def response
    case
    when asking_for_categories?
      categories_response
    when asking_for_products?
      products_response
    when asking_for_cart?
      { text: "Opening your cart:", url: Rails.application.routes.url_helpers.cart_path }
    when asking_for_orders?
      { text: "Your orders:", url: Rails.application.routes.url_helpers.orders_path }
    when asking_for_help?
      help_response
    else
      gemini_fallback
    end
  end

  private

  def asking_for_categories?
    @message.match?(/категор|вид товар|тип/i)
  end

  def asking_for_products?
    @message.match?(/товар|продукт|доступ|є|яка|що/i)
  end

  def asking_for_cart?
    @message.match?(/кошик|оформ|купи|замов/i)
  end

  def asking_for_orders?
    @message.match?(/замовлення|замовлен|мої|історія|сум|скільки/i)
  end

  def asking_for_contact?
    @message.match?(/контакт|телефон|адрес|пошта|email|звонок|звонил/i)
  end

  def asking_for_help?
    @message.match?(/допомог|допомога|як|де|що/i)
  end

  def categories_response
    categories = Category.pluck(:name)
    if categories.any?
      text = "Available categories:\n" + categories.map { |c| "- #{c}" }.join("\n")
      { text: text, url: Rails.application.routes.url_helpers.categories_path }
    else
      { text: "No categories available yet.", url: nil }
    end
  end

  def products_response
    products = Product.order(created_at: :desc).limit(5).pluck(:name)
    if products.any?
      text = "Recent products:\n" + products.map { |p| "- #{p}" }.join("\n")
      { text: text, url: Rails.application.routes.url_helpers.products_path }
    else
      { text: "No products available yet.", url: nil }
    end
  end

  def help_response
    {
      text: "I can help you with:\n" +
            "- Browse categories\n" +
            "- Find products\n" +
            "- View your cart\n" +
            "- Check orders\n" +
            "- Contact information\n\n" +
            "What would you like to do?",
      url: nil
    }
  end

  def gemini_fallback
    # Local dictionary-based responses instead of Gemini
    responses = {
  # Привітання
  /привіт|привет|hi|hello|hey|хай|даров|здорова|добрий день|добрый день|good morning|good evening/ =>
    "Привіт! 👋 Рада вас бачити. Чим можу допомогти сьогодні?",

  # Подяка
  /дякую|спасибо|thanks|thank|благодарю|вдячн/ =>
    "Завжди рада допомогти! 😊 Якщо маєте ще питання — питайте!",

  # Як справи
  /як справи|как дела|how are you|how r u|що нового/ =>
    "Все чудово! 😄 Працюю, щоб зробити ваш досвід ще кращим. А як ви?",

  # Прощання
  /до свидания|до побачення|bye|goodbye|пока|бувай|до зустрічі/ =>
    "До зустрічі! 👋 Гарного дня та приємних покупок!",

  # Ціни
  /скільки коштує|цена|price|вартість|скільки буде|дорого|дешево/ =>
    "Ціни залежать від конкретного товару. Відвідайте каталог, щоб переглянути деталі 🛍️.",

  # Доставка
  /доставка|shipping|доставляєте|доставляет|коли приїде|доставку|як швидко привозите/ =>
    "Ми доставляємо по всій Україні 🚚. Термін доставки — 3–7 днів залежно від міста.",

  # Як замовити
  /як замовити|how to order|order|замовлення зробити|оформити покупку|купити/ =>
    "Щоб замовити, додайте товар у кошик і натисніть 'Оформити замовлення'. Це швидко та просто! 🛒",

  # Тривалість доставлення
  /скільки днів|як довго|как долго|коли отримаю|затримка|затрималось/ =>
    "Зазвичай доставка триває 3–7 днів. Якщо виникла затримка — перевірте статус замовлення.",

  # Косметика / вода / зволоження
  /вода|water|aqua|зволожуючий|увлажняющ|hydration|волог/ =>
    "Рекомендую зволожуючі засоби — у нас їх багато! Перегляньте категорію 'Догляд за шкірою' 💧.",

  # Креми, маски, догляд
  /крем|cream|маска|mask|лосьйон|тонік|серум|essence|сироватк/ =>
    "У нас великий вибір доглядових засобів: креми, сироватки, маски. Загляньте в каталог 🌸.",

  # Акції та знижки
  /прибыль|зиск|скидка|discount|знижка|акция|акції|розпродаж|sale/ =>
    "Зараз є чудові акції! 🎉 Перевіряйте розділ 'Акції', щоб не пропустити вигідні пропозиції.",

  # Проблеми зі шкірою
  /висип|прищі|акне|жирна шкіра|суха шкіра|комедони|червон/ =>
    "Для проблемної шкіри радимо засоби з niacinamide, AHA/BHA, цинком. Перегляньте категорію 'Догляд за обличчям'.",

  # Волосся
  /волосся|hair|шампунь|бальзам|маска для волос|пошкоджен/ =>
    "Для волосся є шампуні, бальзами, маски та олії. Підійдуть для різних типів волосся ✨.",

  # Тіло
  /тіло|body|скраб|лосьйон для тіла|догляд за тілом/ =>
    "У нас є скраби, лосьйони, креми для тіла. Оберіть те, що вам підходить ❤️.",

  # Алергії
  /алергія|реакція|почервоніння|rash|irritation/ =>
    "Раджу звернути увагу на гіпоалергенні засоби без ароматизаторів. Безпека — перш за все 🌿.",

  # Оплата
  /оплата|payment|картка|card|visa|mastercard|apple pay|pay|cash/ =>
    "Ми приймаємо оплату карткою, Google/Apple Pay або післяплатою. Оберіть зручний спосіб 💳.",

  # Повернення
  /повернення|refund|вернуть|гарантія|обмін|повернути товар/ =>
    "Повернення можливе протягом 14 днів за умов збереження товарного вигляду. Деталі — у політиці повернень.",

  # Рекомендації
  /порадь|recommend|що краще|який вибрати|що підійде|який продукт/ =>
    "Рекомендації залежать від типу шкіри та потреб. Хочете, я підкажу щось за вашими критеріями? 😊",

  # Пошук товарів
  /шукаю|искал|find|search|потрібен товар|мені треба|є в наявності/ =>
    "Я можу допомогти знайти товар! Напишіть, що саме шукаєте 🔍.",

  # Наявність
  /в наявності|instock|є?|наличие|коли буде/ =>
    "Інформацію про наявність можна знайти на сторінці товару. Дані оновлюються автоматично.",

  # Подарунки
  /подарунок|gift|кому подарувати|подарочн/ =>
    "У нас є чудові косметичні набори — ідеальні для подарунків 🎁.",

  # Чоловічі товари
  /чоловіч|men|для мужчин/ =>
    "Маємо засоби для чоловічого догляду: креми, засоби для гоління, шампуні 💼.",

  # Сонцезахист
  /spf|сонцезахист|sunscreen|захист від сонця/ =>
    "SPF — must-have! ☀️ У нас є сонцезахисні креми для обличчя та тіла.",

  # Старіння
  /антивіков|anti age|anti-age|зморшки|морщин/ =>
    "Антивікові засоби допомагають покращити еластичність шкіри. Перегляньте категорію Anti-Age.",

  # Описи запахів
  /запах|аромат|fragrance|духи|парфюм/ =>
    "У нас є аромати з ніжними та насиченими нотами. Оберіть той, який вам ближчий 🌺.",

  # Питання про магазин
  /хто ви|що за магазин|інформація про компанію/ =>
    "HealthyBeauty — це магазин косметики та догляду за тілом. Працюємо по всій Україні 💗.",

  # Проблеми з замовленням
  /проблема|issue|не працює|не відкривається|помилка|error/ =>
    "Ой! Якщо щось не працює — напишіть деталі, і я допоможу вирішити проблему 💡.",

  # Все інше
  /що порадиш|який засіб|чим відрізняється|help me choose/ =>
    "Можу запропонувати кілька варіантів! Опишіть вашу шкіру або потреби 🙌."
}


    responses.each do |pattern, answer|
      return { text: answer, url: nil } if @message.match?(pattern)
    end

    # Default fallback message
    { text: "Вибачте, я не розумію ваше запитання. Спробуйте запитати про категорії, товари, доставку чи замовлення.", url: nil }
  end
end
